<template id="mi-temp-billing-payment">
  <style type="text/css">
    * {
      font-family: system-ui;
    }

    .card {
      box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
      transition: 0.3s;
      border-radius: 5px;
      /* 5px rounded corners */
      margin: 10px;
      min-width: 300px;
      padding: 10px;
    }

    .card-row {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(150, 150, 150, 0.3);
    }

    #title {
      margin: 15px;
      color: #1f5da6;
      font-weight: 500;
    }

    .label {
      color: #4b4b4b;
      font-weight: 500;
      padding: 5px 15px;
      margin: 0;
      font-size: 12px;
    }

    .sub-label {
      color: #4b4b4b;
      font-weight: 500;
      padding: 5px 15px;
      margin: 0;
      font-size: 12px;
      text-align: end;
      font-weight: 700;
    }

    .sub-label span {
      color: #a7a7a7;
      font-weight: 500;
    }

    .value {
      padding: 5px 15px;
      margin: 0;
      font-weight: 600;
      font-size: 16px;
    }

    .linkBox {
      text-align: end;
      margin: 15px 10px 5px;
    }

    .card .linkBox #link {
      color: #1f5da6;
      text-decoration: none;
      margin: 10px;
      font-weight: 500;
      font-size: 12px;
    }
  </style>

  <div class="card">
    <h3 id="title"></h3>
    <div id="content"></div>

    <div class="linkBox">
      <a id="link"></a>
    </div>
  </div>
</template>

<script>
  const miTempBillingPaymentTemplate = document.querySelector(
    "#mi-temp-billing-payment"
  );
  class MI_BILLING_PAYMENT extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({ mode: "open" });
      this.shadowRoot.appendChild(
        miTempBillingPaymentTemplate.content.cloneNode(true)
      );
    }

    static get observedAttributes() {
      return [
        "title",
        "link",
        "link-msg",
        "dates-data",
        "bill-data",
        "payment-data",
      ];
    }

    attributeChangedCallback(attribute, oldValue, newValue) {
      if (attribute == "title") {
        this.shadowRoot.querySelector("#title").innerHTML =
          newValue.toUpperCase();
      }
      if (attribute == "link") {
        this.shadowRoot.querySelector("#link").href = newValue;
      }
      if (attribute == "link-msg") {
        this.shadowRoot.querySelector("#link").innerHTML = newValue + " >";
      }

      if (attribute == "dates-data") {
        let data = JSON.parse(newValue);
        this.loadDates(data);
      }

      if (attribute == "payment-data") {
        let data = JSON.parse(newValue);
        this.loadPayment(data);
      }

      if (attribute == "bill-data") {
        let data = JSON.parse(newValue);
        this.loadBills(data);
      }
    }

    loadDates(arr) {
      arr.forEach((date) => {
        let section = document.createElement("div");
        section.className = "card-row";

        let ele = document.createElement("h3");
        ele.innerHTML = date;
        ele.className = "label";
        section.appendChild(ele);
        this.shadowRoot.querySelector("#content").appendChild(section);
      });
    }
    loadPayment(arr) {
      let cardRows = this.shadowRoot.querySelectorAll(".card-row");
      cardRows.forEach((row, x) => {
        let ele = document.createElement("p");
        try {
          ele.innerHTML = `<span>Payment:</span> $${arr[x]}`;
          ele.className = "sub-label";
        } catch {
          return;
        }

        row.appendChild(ele);
      });
    }
    loadBills(arr) {
      let cardRows = this.shadowRoot.querySelectorAll(".card-row");
      cardRows.forEach((row, x) => {
        let ele = document.createElement("p");
        try {
          ele.innerHTML = `<span>Bill:</span> $${arr[x]}`;
          ele.className = "sub-label";
        } catch {
          return;
        }

        row.appendChild(ele);
      });
    }
  }
  customElements.define("mi-billing-payment", MI_BILLING_PAYMENT);
</script>

<template id="grapy">
  <style type="text/css">
    .box {
      border-radius: 0.5em;
      padding: 2px;
      cursor: move;
    }

    .box.over {
      border: 3px dotted #666;
    }

    [draggable] {
      user-select: none;
    }

    .container {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      grid-auto-flow: row;
    }
  </style>

  <div id="container" class="container"></div>
</template>

<script>
  const grapyTemplate = document.querySelector("#grapy");
  class Grapy extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({ mode: "open" });
      this.shadowRoot.appendChild(grapyTemplate.content.cloneNode(true));
      this.onMutation = this.onMutation.bind(this);
      linkEvents(this.shadowRoot);
    }

    static get observedAttributes() {
      return [
        "map_style",
      ];
    }

    attributeChangedCallback(attribute, oldValue, newValue) {
      if (attribute == "map_style") {
        this.shadowRoot.querySelector("#container").setAttribute("style", newValue);
      }
    }

    connectedCallback() {
      // Set up observer
      this.observer = new MutationObserver(this.onMutation);

      // Watch the Light DOM for child node changes
      this.observer.observe(this, { childList: true });
    }

    disconnectedCallback() {
      // remove observer if element is no longer connected to DOM
      this.observer.disconnect();
    }

    onMutation(mutations) {
      const added = [];

      // A `mutation` is passed for each new node
      for (const mutation of mutations) {
        // Could test for `mutation.type` here, but since we only have
        // set up one observer type it will always be `childList`
        added.push(...mutation.addedNodes);
      }

      let divs = added.filter((el) => el.nodeType === Node.ELEMENT_NODE);
      this.setUpBoxes(divs);
    }

    setUpBoxes(childs) {
      this.disconnectedCallback();
      childs.forEach((ele) => {
        let wrappedEle = this.wrap(ele);    
        this.shadowRoot.querySelector("#container").appendChild(wrappedEle);
      });
      this.connectedCallback();

      console.log("item");
    }

    wrap(el) {
      let wrapper = document.createElement("div");
      wrapper.setAttribute("class", "box");
      wrapper.setAttribute("draggable", "true");
      el.parentNode.insertBefore(wrapper, el);
      wrapper.appendChild(el);
      return wrapper;
    }
  }
  customElements.define("mi-grapy", Grapy);

  function linkEvents(shadowRoot) {
    document.addEventListener("DOMContentLoaded", (event) => {
      var dragSrcEl = null;

      function handleDragStart(e) {
        this.style.opacity = "0.4";

        dragSrcEl = this;

        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/html", this.innerHTML);
      }

      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }

        e.dataTransfer.dropEffect = "move";

        return false;
      }

      function handleDragEnter(e) {
        this.classList.add("over");
      }

      function handleDragLeave(e) {
        this.classList.remove("over");
      }

      function handleDrop(e) {
        if (e.stopPropagation) {
          e.stopPropagation(); // stops the browser from redirecting.
        }

        if (dragSrcEl != this) {
          dragSrcEl.innerHTML = this.innerHTML;
          this.innerHTML = e.dataTransfer.getData("text/html");
        }

        return false;
      }

      function handleDragEnd(e) {
        this.style.opacity = "1";

        items.forEach(function (item) {
          item.classList.remove("over");
        });
      }

      let items = shadowRoot.querySelectorAll(".container .box");
      console.log(items);
      items.forEach(function (item) {
        item.addEventListener("dragstart", handleDragStart, false);
        item.addEventListener("dragenter", handleDragEnter, false);
        item.addEventListener("dragover", handleDragOver, false);
        item.addEventListener("dragleave", handleDragLeave, false);
        item.addEventListener("drop", handleDrop, false);
        item.addEventListener("dragend", handleDragEnd, false);
      });
    });
  }
</script>

<!-- Example For Actual Elements For User To Use -->
<mi-grapy
class="container"
map_style="display: grid; grid-template-columns: 30% 2fr 1fr;"
>
  <p>AidA</p>
  <p>AidB</p>
  <mi-billing-payment
    title="Billing & Payment History"
    link="https://www.google.com"
    link-msg="View More"
    dates-data='["November 2, 2021","October 2, 2021", "September 2, 2021","Augest 2, 2021"]'
    bill-data="[91.46,91.46,91.46,91.46]"
    payment-data="[91.46,91.46,91.46,91.46]"
  >
  </mi-billing-payment>
  <p>AidD</p>
</mi-grapy>
